<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.tenant.business.mapper.TbOrderRecordMapper">
    
    <resultMap type="TbOrderRecord" id="TbOrderRecordResult">
        <result property="id"    column="id"    />
        <result property="userId"    column="user_id"    />
        <result property="userName"    column="user_name"    />
        <result property="type"    column="type"    />
        <result property="payType"    column="pay_type"    />
        <result property="name"    column="name"    />
        <result property="account"    column="account"    />
        <result property="imageId"    column="image_id"    />
        <result property="bankName"    column="bank_name"    />
        <result property="score"    column="score"    />
        <result property="leftScore"    column="left_score"    />
        <result property="isSame"    column="is_same"    />
        <result property="auditUserId"    column="audit_user_id"    />
        <result property="auditUserName"    column="audit_user_name"    />
        <result property="status"    column="status"    />
        <result property="auditTime"    column="audit_time"    />
        <result property="delFlag"    column="del_flag"    />
        <result property="createBy"    column="create_by"    />
        <result property="createTime"    column="create_time"    />
        <result property="updateBy"    column="update_by"    />
        <result property="updateTime"    column="update_time"    />
        <result property="remark"    column="remark"    />
        <result property="tenantId"    column="tenant_id"    />
        <result property="lastPayName"    column="last_pay_name"    />
        <result property="vipAccountId"    column="vip_account_id"    />
    </resultMap>

    <sql id="selectTbOrderRecordVo">
        select * from tb_order_record
    </sql>

    <select id="selectTbOrderRecordList" parameterType="TbOrderRecord" resultMap="TbOrderRecordResult">
        <include refid="selectTbOrderRecordVo"/>
        <where>  
            <if test="id != null "> and id = #{id}</if>
            <if test="userId != null "> and user_id = #{userId}</if>
            <if test="userName != null  and userName != ''"> and user_name like concat('%', #{userName}, '%')</if>
            <if test="type != null "> and type = #{type}</if>
            <if test="payType != null  and payType != ''"> and pay_type like concat('%', #{payType}, '%')</if>
            <if test="name != null  and name != ''"> and name like concat('%', #{name}, '%')</if>
            <if test="status != null  and status != ''"> and status = #{status}</if>
            <if test="createBy != null  and createBy != ''"> and create_by = #{createBy}</if>
            <if test="params.beginCreateTime != null and params.beginCreateTime != '' and params.endCreateTime != null and params.endCreateTime != ''"> and create_time between #{params.beginCreateTime} and #{params.endCreateTime}</if>
            <if test="tenantId != null "> and tenant_id = #{tenantId}</if>
        </where>
        order by id desc
    </select>

    <select id="selectTbOrderRecordListForApp" parameterType="TbOrderRecord" resultMap="TbOrderRecordResult">
        <include refid="selectTbOrderRecordVo"/>
        <where>
            <if test="id != null "> and id = #{id}</if>
            <if test="userId != null "> and user_id = #{userId}</if>
            <if test="userName != null  and userName != ''"> and user_name like concat('%', #{userName}, '%')</if>
            <if test="type == 1 "> and type in(1,3)</if>
            <if test="type == 2 "> and type in(2,4)</if>
            <if test="type == 3 "> and type in(5,13,15)</if>
            <if test="payType != null  and payType != ''"> and pay_type like concat('%', #{payType}, '%')</if>
            <if test="name != null  and name != ''"> and name like concat('%', #{name}, '%')</if>
            <if test="status != null "> and status = #{status}</if>
            <if test="createBy != null  and createBy != ''"> and create_by = #{createBy}</if>
            <if test="params.beginCreateTime != null and params.beginCreateTime != '' and params.endCreateTime != null and params.endCreateTime != ''"> and create_time between #{params.beginCreateTime} and #{params.endCreateTime}</if>
            <if test="tenantId != null "> and tenant_id = #{tenantId}</if>
        </where>

        order by id desc
    </select>

    <select id="auditScore" resultType="double">
        select IFNULL(sum(score),0) auditScore from tb_order_record
        <where>
            and status = 1
            <if test="id != null "> and id = #{id}</if>
            <if test="userId != null "> and user_id = #{userId}</if>
            <if test="userName != null  and userName != ''"> and user_name like concat('%', #{userName}, '%')</if>
            <if test="type != null "> and type = #{type}</if>
            <if test="payType != null  and payType != ''"> and pay_type like concat('%', #{payType}, '%')</if>
            <if test="name != null  and name != ''"> and name like concat('%', #{name}, '%')</if>
            <if test="createBy != null  and createBy != ''"> and create_by = #{createBy}</if>
            <if test="params.beginCreateTime != null and params.beginCreateTime != '' and params.endCreateTime != null and params.endCreateTime != ''"> and create_time between #{params.beginCreateTime} and #{params.endCreateTime}</if>
            <if test="tenantId != null "> and tenant_id = #{tenantId}</if>
        </where>
    </select>

    <select id="availableCount" resultType="int">
        select IFNULL(count(1),0) from tb_order_record
        <where>
            and status in (0,1) and type in(2,4) and create_time>=DATE_FORMAT(now(), '%Y-%m-%d')
            <if test="userId != null "> and user_id = #{userId}</if>
        </where>
    </select>

    <select id="todayLiushui" parameterType="TbOrderRecord" resultType="double">
        select IFNULL(sum(score),0) from tb_order_record
        <where>
            `status`= 1 and type in (1,3) and user_id = #{userId} and create_time>=DATE_FORMAT(now(), '%Y-%m-%d')
        </where>
    </select>

    <select id="todayLuckyDrawCount" parameterType="TbOrderRecord" resultType="int">
        select IFNULL(count(1),0) from tb_order_record
        <where>
            `status`= 1 and type in (8) and user_id = #{userId} and create_time>=DATE_FORMAT(now(), '%Y-%m-%d')
        </where>
    </select>

    <select id="statisticsDashboardRecord" parameterType="TbOrderRecord" resultType="map">
        select IFNULL(sum(case when type in (1,3) then score else 0 end),0) addScore,IFNULL(sum(case when type in (2,4) then score else 0 end),0) minusScore from tb_order_record
        <where>
            `status`= 1 and tenant_id = #{tenantId} and create_time>=#{createTime}
        </where>
    </select>

    <select id="selectUpList" parameterType="TbOrderRecord" resultMap="TbOrderRecordResult">
        <include refid="selectTbOrderRecordVo"/>
        <where>
             type in (1,3) and status=0 and tenant_id = #{tenantId} and create_time>=#{createTime}
        </where>
        order by id desc
    </select>

    <select id="selectDownList" parameterType="TbOrderRecord" resultMap="TbOrderRecordResult">
        <include refid="selectTbOrderRecordVo"/>
        <where>
             type in (2,4) and status=0 and tenant_id = #{tenantId} and create_time>=#{createTime}
        </where>
        order by id desc
    </select>
    
    <select id="selectTbOrderRecordById" parameterType="Long" resultMap="TbOrderRecordResult">
        <include refid="selectTbOrderRecordVo"/>
        where id = #{id}
    </select>
        
    <insert id="insertTbOrderRecord" parameterType="TbOrderRecord" useGeneratedKeys="true" keyProperty="id">
        insert into tb_order_record
        <trim prefix="(" suffix=")" suffixOverrides=",">
            <if test="userId != null">user_id,</if>
            <if test="userName != null">user_name,</if>
            <if test="type != null">type,</if>
            <if test="payType != null">pay_type,</if>
            <if test="name != null">name,</if>
            <if test="account != null">account,</if>
            <if test="imageId != null">image_id,</if>
            <if test="bankName != null">bank_name,</if>
            <if test="score != null">score,</if>
            <if test="leftScore != null">left_score,</if>
            <if test="isSame != null">is_same,</if>
            <if test="auditUserId != null">audit_user_id,</if>
            <if test="auditUserName != null">audit_user_name,</if>
            <if test="status != null">status,</if>
            <if test="auditTime != null">audit_time,</if>
            <if test="delFlag != null">del_flag,</if>
            <if test="createBy != null">create_by,</if>
            <if test="createTime != null">create_time,</if>
            <if test="updateBy != null">update_by,</if>
            <if test="updateTime != null">update_time,</if>
            <if test="remark != null">remark,</if>
            <if test="tenantId != null">tenant_id,</if>
            <if test="lastPayName != null">last_pay_name,</if>
            <if test="vipAccountId != null">vip_account_id,</if>
         </trim>
        <trim prefix="values (" suffix=")" suffixOverrides=",">
            <if test="userId != null">#{userId},</if>
            <if test="userName != null">#{userName},</if>
            <if test="type != null">#{type},</if>
            <if test="payType != null">#{payType},</if>
            <if test="name != null">#{name},</if>
            <if test="account != null">#{account},</if>
            <if test="imageId != null">#{imageId},</if>
            <if test="bankName != null">#{bankName},</if>
            <if test="score != null">#{score},</if>
            <if test="leftScore != null">#{leftScore},</if>
            <if test="isSame != null">#{isSame},</if>
            <if test="auditUserId != null">#{auditUserId},</if>
            <if test="auditUserName != null">#{auditUserName},</if>
            <if test="status != null">#{status},</if>
            <if test="auditTime != null">#{auditTime},</if>
            <if test="delFlag != null">#{delFlag},</if>
            <if test="createBy != null">#{createBy},</if>
            <if test="createTime != null">#{createTime},</if>
            <if test="updateBy != null">#{updateBy},</if>
            <if test="updateTime != null">#{updateTime},</if>
            <if test="remark != null">#{remark},</if>
            <if test="tenantId != null">#{tenantId},</if>
            <if test="lastPayName != null">#{lastPayName},</if>
            <if test="vipAccountId != null">#{vipAccountId},</if>
         </trim>
    </insert>

    <update id="updateTbOrderRecord" parameterType="TbOrderRecord">
        update tb_order_record
        <trim prefix="SET" suffixOverrides=",">
            <if test="userId != null">user_id = #{userId},</if>
            <if test="userName != null">user_name = #{userName},</if>
            <if test="type != null">type = #{type},</if>
            <if test="payType != null">pay_type = #{payType},</if>
            <if test="name != null">name = #{name},</if>
            <if test="account != null">account = #{account},</if>
            <if test="imageId != null">image_id = #{imageId},</if>
            <if test="bankName != null">bank_name = #{bankName},</if>
            <if test="score != null">score = #{score},</if>
            <if test="leftScore != null">left_score = #{leftScore},</if>
            <if test="isSame != null">is_same = #{isSame},</if>
            <if test="auditUserId != null">audit_user_id = #{auditUserId},</if>
            <if test="auditUserName != null">audit_user_name = #{auditUserName},</if>
            <if test="status != null">status = #{status},</if>
            <if test="auditTime != null">audit_time = #{auditTime},</if>
            <if test="delFlag != null">del_flag = #{delFlag},</if>
            <if test="createBy != null">create_by = #{createBy},</if>
            <if test="createTime != null">create_time = #{createTime},</if>
            <if test="updateBy != null">update_by = #{updateBy},</if>
            <if test="updateTime != null">update_time = #{updateTime},</if>
            <if test="remark != null">remark = #{remark},</if>
            <if test="tenantId != null">tenant_id = #{tenantId},</if>
            <if test="lastPayName != null">last_pay_name = #{lastPayName},</if>
            <if test="vipAccountId != null">vip_account_id = #{vipAccountId},</if>
        </trim>
        where id = #{id}
        <if test="createBy != null  and createBy != ''"> and create_by = #{createBy}</if>
    </update>

    <delete id="deleteTbOrderRecordById" parameterType="Long">
        delete from tb_order_record where id = #{id}
    </delete>

    <delete id="deleteByRange" >
        delete from tb_order_record where tenant_id = #{tenantId} and create_time between #{startTime} and #{endTime}
    </delete>

    <delete id="deleteTbOrderRecordByIds" parameterType="String">
        delete from tb_order_record where
        <if test="createBy != null and createBy != ''">  create_by = #{createBy} and</if>
id in
        <foreach item="id" collection="ids" open="(" separator="," close=")">
            #{id}
        </foreach>
    </delete>

</mapper>